<style type="text/css">
.FR {
	float:right;
}
.FL {
	float:left;
}
.labelTextInput {
	display:block;
	font-size:8pt;
}
h1 {
	font-size:20pt;
}
#validation_msg {
	font-style:italic;
}
</style>
<h1><img src="images/icon48.png" style="float:left"/><span style="float:right">Pwdhash<br/>Settings</span></h1>
<br style="clear:both" />
<form id="pwdhash_menu" style="width:250px;">
<p><label for="domain" class="labelTextInput">Alternative domain</label>
	<input type="text" id="domain" value="" /></p>

<p><input type="checkbox" id="alertPwd" />
	<label for="alertPwd">Show passwd/hash</label></p>
<p><input type="checkbox" id="noIntercept" />
	<label for="noIntercept">Disable interception security</label></p>
	
<center>
	<p id="validation_msg"/></p>
	<input type="button" id="validate" value="Save changes" />
</center>
</form>
<script type="text/javascript">
(function () {

var $ = function (id) {
	var o = new (function (e) {
		this.htmlElement = e;
		this.click = function (fn) { e.addEventListener('click', fn); return o; };
		this.blur = function (fn) { e.addEventListener('blur', fn); return o; };
		this.val = function (a1) {
			if (a1 == undefined) {
				if (e.type == 'checkbox')
					return e.checked; 
					else return e.value; 
			}
			if (e.type == 'checkbox') {
				e.checked = a1;
			}
				else e.value = a1;
			
			return o;
		};
	})(document.getElementById(id));
	return o;
};

var sendRequest = function (params, callback) {
	chrome.tabs.getSelected(null, function(tab) {
		chrome.tabs.sendRequest(tab.id, params, callback);
	});
};

var old_domain;
var old_alertPwd;

sendRequest({controller: 'AlternativeDomain', action: "getDomain"}, function(response) {
	$('domain').val(response.domain);
	old_domain = response.domain;
});

var init_setting = function (k) {
	sendRequest({controller: 'Settings', action: "retrieve", key: k}, function(response) {
		$(k).val(response.value);
		old[k] = response.value;
	});
	settings_send[k] = function () {
		if (old[k] != $(k).val()) {
			sendRequest({controller: 'Settings', action: "store", key: k, value: $(k).val()}, function () { old[k] = $(k).val(); });
		}
	};
};

var old = {};
var settings_send = {};
var settings = ['alertPwd', 'noIntercept'];
for (var k in settings) {
	init_setting(settings[k]);
}

$('validate').click(function () {
	if (old_domain != $('domain').val()) {
		sendRequest({controller: 'AlternativeDomain', action: "setDomain", domain: $('domain').val()}, function () { old_domain = $('domain').val(); });
	}
	for (var k in settings_send) {
		settings_send[k]();
	}
	$('validation_msg').htmlElement.innerHTML = 'New settings saved !';
	window.setTimeout(function () { $('validation_msg').htmlElement.innerHTML = ''; }, 2000);
});

})();
</script>
